name: Auto label PR from linked issue

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  issues: write
  pull-requests: write

jobs:
  label-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Label PR based on linked issue
        uses: actions/github-script@v7
        with:
          script: |
            console.log("PR body:", context.payload.pull_request.body);
            
            const pr = context.payload.pull_request;
            const body = pr.body || "";

            // Debug: Log full body
            console.log("Full body length:", body.length);

            // More flexible regex: capture #123 anywhere, case-insensitive
            const match = body.match(/#(\d+)/i);
            if (!match) {
              console.log("‚ùå No issue # found in body.");
              return;
            }

            const issueNumber = Number(match[1]);
            console.log("üìã Found issue:", issueNumber);

            try {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              console.log("Issue labels:", issue.labels.map(l => l.name));

              const difficulty = ["Easy", "Medium", "Hard"].find(l => 
                issue.labels.some(label => label.name === l)
              );

              if (!difficulty) {
                console.log("‚ùå No difficulty label (Easy/Medium/Hard) on issue.");
                return;
              }

              const labelsToAdd = [difficulty, "SWoC26"];
              console.log("‚ûï Adding labels:", labelsToAdd);

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labelsToAdd
              });

              console.log("‚úÖ Labels added successfully!");
            } catch (error) {
              console.error("‚ùå Error:", error.message);
              if (error.status) console.error("Status:", error.status);
            }
